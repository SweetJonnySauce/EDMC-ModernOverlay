name: CI

on:
  push:
    branches: [main, master, ilities]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  plugin-tests-310:
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      PYTHONUTF8: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (Qt/EGL)
        run: sudo apt-get update && sudo apt-get install -y libegl1 libgl1

      - name: Set up Python (plugin runtime parity)
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements/dev.txt

      - name: Check EDMC Python baseline
        run: python scripts/check_edmc_python.py
        env:
          ALLOW_EDMC_PYTHON_MISMATCH: "1"

      - name: Run plugin checks
        run: make check

  tests:
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      PYTHONUTF8: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (Qt/EGL)
        run: sudo apt-get update && sudo apt-get install -y libegl1 libgl1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements/dev.txt

      - name: Check EDMC Python baseline
        run: python scripts/check_edmc_python.py
        env:
          ALLOW_EDMC_PYTHON_MISMATCH: "1"

      - name: Run checks
        run: make check

  linux-installer-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Linux installer tests
        run: bash tests/test_install_linux.sh

  windows-installer-tests:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Pester 5
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Remove-Module Pester -ErrorAction SilentlyContinue
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          $pester = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge [version]'5.5.0' } | Select-Object -First 1
          if (-not $pester) {
            Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
            Install-Module -Name Pester -MinimumVersion 5.5.0 -Force -Scope CurrentUser
            $pester = Get-Module -ListAvailable -Name Pester | Where-Object { $_.Version -ge [version]'5.5.0' } | Select-Object -First 1
          }
          Import-Module $pester -Force
          Get-Module Pester | Select-Object Name,Version | Format-Table -AutoSize

      - name: Run Windows installer tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Remove-Module Pester -ErrorAction SilentlyContinue
          Import-Module Pester -MinimumVersion 5.5.0 -Force
          Write-Host ("Using Pester {0}" -f (Get-Module Pester).Version)
          $config = @{
            Run = @{ Path = 'tests/install_windows.Tests.ps1' }
            TestResult = @{
              Enabled     = $true
              OutputPath  = 'Test-Pester.xml'
              OutputFormat= 'NUnitXml'
            }
          }
          Invoke-Pester -Configuration $config

  virustotal-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      - plugin-tests-310
      - tests
      - linux-installer-tests
      - windows-installer-tests
    # Avoid PRs (no secrets) and limit to tags or manual runs to manage VT quota.
    if: >
      github.event_name != 'pull_request' &&
      (github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare scan bundle
        run: |
          set -euo pipefail
          mkdir -p dist
          git archive --format=zip -o dist/EDMCModernOverlay-source.zip HEAD

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install VirusTotal client deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Scan artifacts with VirusTotal
        env:
          VT_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import glob
          import json
          import os
          import pathlib
          import sys
          import time

          import requests

          api_key = os.environ.get("VT_API_KEY")
          if not api_key:
              sys.exit("VIRUSTOTAL_API_KEY secret is not configured")

          session = requests.Session()
          session.headers["x-apikey"] = api_key

          targets = [p for p in glob.glob("dist/**/*", recursive=True) if pathlib.Path(p).is_file()]
          if not targets:
              sys.exit("No files in dist/ to scan")

          def upload(path: str) -> str:
              with open(path, "rb") as handle:
                  response = session.post(
                      "https://www.virustotal.com/api/v3/files",
                      files={"file": (os.path.basename(path), handle)},
                      timeout=60,
                  )
              response.raise_for_status()
              return response.json()["data"]["id"]

          def wait_for_result(analysis_id: str) -> dict:
              while True:
                  resp = session.get(
                      f"https://www.virustotal.com/api/v3/analyses/{analysis_id}",
                      timeout=30,
                  )
                  resp.raise_for_status()
                  data = resp.json()["data"]
                  status = data["attributes"]["status"]
                  if status == "completed":
                      return data["attributes"]["stats"]
                  time.sleep(15)

          badge_dir = pathlib.Path("badge_out")
          badge_dir.mkdir(parents=True, exist_ok=True)
          badge_path = badge_dir / "virustotal.json"

          flagged = []
          suspicious_hits = []

          for path in targets:
              print(f"Uploading {path}")
              analysis_id = upload(path)
              stats = wait_for_result(analysis_id)
              malicious = stats.get("malicious", 0)
              suspicious_count = stats.get("suspicious", 0)
              if malicious:
                  flagged.append((path, stats))
              elif suspicious_count:
                  suspicious_hits.append((path, stats))
              else:
                  print(f"{path} clean: {stats}")

          if flagged:
              message = f"flagged ({len(flagged)})"
              color = "red"
          elif suspicious_hits:
              message = f"suspicious ({len(suspicious_hits)})"
              color = "orange"
          else:
              message = "clean"
              color = "brightgreen"

          badge = {
              "schemaVersion": 1,
              "label": "VirusTotal",
              "message": message,
              "color": color,
              "cacheSeconds": 300,
          }
          badge_path.write_text(json.dumps(badge), encoding="utf-8")

          if flagged or suspicious_hits:
              details = [f"{p} -> {s}" for p, s in flagged + suspicious_hits]
              raise SystemExit("VirusTotal issues:\n" + "\n".join(details))
          PY

      - name: Publish VirusTotal badge (vt-badges branch)
        if: always() && hashFiles('badge_out/virustotal.json') != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: vt-badges
          publish_dir: badge_out
          keep_files: true
          commit_message: "Update VirusTotal badge (CI)"
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
