name: CI

on:
  push:
    branches: [main, master, ilities]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  plugin-tests-310:
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      PYTHONUTF8: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (Qt/EGL)
        run: sudo apt-get update && sudo apt-get install -y libegl1 libgl1

      - name: Set up Python (plugin runtime parity)
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements/dev.txt

      - name: Check EDMC Python baseline
        run: python scripts/check_edmc_python.py
        env:
          ALLOW_EDMC_PYTHON_MISMATCH: "1"

      - name: Run plugin checks
        run: make check

  tests:
    runs-on: ubuntu-latest
    env:
      QT_QPA_PLATFORM: offscreen
      PYTHONUTF8: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (Qt/EGL)
        run: sudo apt-get update && sudo apt-get install -y libegl1 libgl1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements/dev.txt

      - name: Check EDMC Python baseline
        run: python scripts/check_edmc_python.py
        env:
          ALLOW_EDMC_PYTHON_MISMATCH: "1"

      - name: Run checks
        run: make check

  linux-installer-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Linux installer tests
        run: bash tests/test_install_linux.sh

  windows-installer-tests:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Pester 5
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name Pester -MinimumVersion 5.5.0)) {
              Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
              Install-Module -Name Pester -MinimumVersion 5.5.0 -Force -Scope CurrentUser
          }

      - name: Run Windows installer tests
        shell: pwsh
        run: Invoke-Pester -CI tests/install_windows.Tests.ps1
