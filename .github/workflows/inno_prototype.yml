name: Inno Installer Prototype
permissions:
  contents: read

on:
  workflow_dispatch: {}
  push:
    branches:
      - "inno/*"

env:
  VERSION: ${{ github.event.release.tag_name || github.ref_name || format('run-{0}', github.run_number) }}

jobs:
  build:
    name: Build unsigned Inno installer
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Verify release build is not in dev mode
        shell: pwsh
        run: |
          python scripts/verify_release_not_dev.py

      - name: Stage payload (apply release excludes)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import shutil
          from fnmatch import fnmatch
          from pathlib import Path

          root = Path.cwd()
          manifest = json.loads((root / "scripts" / "release_excludes.json").read_text())
          exclude_dirs = set(manifest.get("directories", []))
          exclude_root_dirs = set(manifest.get("root_directories", []))
          exclude_files = set(manifest.get("files", []))
          exclude_patterns = manifest.get("patterns", [])
          exclude_substrings = manifest.get("substrings", [])

          payload_root = root / "dist" / "inno_payload" / "EDMCModernOverlay"
          if payload_root.exists():
              shutil.rmtree(payload_root)
          payload_root.mkdir(parents=True, exist_ok=True)

          def should_exclude(path: Path) -> bool:
              rel = path.relative_to(root).as_posix()
              name = path.name
              if path.is_dir() and name in exclude_dirs:
                  return True
              if path.is_dir() and name in exclude_root_dirs and rel.split("/")[0] == name:
                  return True
              if path.is_file() and name in exclude_files:
                  return True
              if any(fnmatch(name, pat) for pat in exclude_patterns):
                  return True
              if any(sub in rel for sub in exclude_substrings):
                  return True
              if rel.startswith("dist/inno_payload"):
                  return True
              return False

          def copy_tree(src: Path, dst: Path):
              if should_exclude(src):
                  return
              if src.is_dir():
                  dst.mkdir(parents=True, exist_ok=True)
                  for child in src.iterdir():
                      copy_tree(child, dst / child.name)
              else:
                  dst.parent.mkdir(parents=True, exist_ok=True)
                  shutil.copy2(src, dst)

          for child in root.iterdir():
              if child.name in {".git", "dist"}:
                  continue
              copy_tree(child, payload_root / child.name)

          tools = root / "dist" / "inno_payload" / "tools"
          tools.mkdir(parents=True, exist_ok=True)
          shutil.copy2(root / "scripts" / "generate_checksums.py", tools / "generate_checksums.py")
          PY

      - name: Generate checksum manifest
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python scripts/generate_checksums.py --root dist/inno_payload --target-dir dist/inno_payload/EDMCModernOverlay --output dist/inno_payload/EDMCModernOverlay/checksums.txt --excludes scripts/release_excludes.json

      - name: Smoke-verify checksum manifest
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python scripts/generate_checksums.py --verify --root dist/inno_payload --manifest dist/inno_payload/EDMCModernOverlay/checksums.txt

      - name: Download embeddable Python
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $url = "https://www.python.org/ftp/python/3.12.3/python-3.12.3-embed-amd64.zip"
          $expected = "38b265fc0612027a126ae54d2485101f041b61893e41ef4f421dee6ac618a99e"
          $zipPath = "dist\\inno_payload\\python_embed.zip"
          $destDir = "dist\\inno_payload\\python"
          New-Item -ItemType Directory -Path (Split-Path $zipPath) -Force | Out-Null
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $actual = (Get-FileHash -Algorithm SHA256 -Path $zipPath).Hash.ToLower()
          if ($actual -ne $expected) {
              Write-Error "Embeddable Python hash mismatch. Expected $expected, got $actual."
              exit 1
          }
          if (Test-Path -LiteralPath $destDir) { Remove-Item -LiteralPath $destDir -Recurse -Force }
          Expand-Archive -LiteralPath $zipPath -DestinationPath $destDir -Force

      - name: Build dependency wheels
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $wheelDir = "dist\\inno_payload\\wheels"
          New-Item -ItemType Directory -Path $wheelDir -Force | Out-Null
          python -m pip install --upgrade pip
          python -m pip wheel -r overlay_client/requirements/base.txt -w $wheelDir

      - name: Bundle Eurocaps font
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $fontDir = "dist\\inno_payload\\extras\\font"
          New-Item -ItemType Directory -Path $fontDir -Force | Out-Null
          $fontUrl = "https://raw.githubusercontent.com/inorton/EDMCOverlay/master/EDMCOverlay/EDMCOverlay/EUROCAPS.TTF"
          $fontPath = Join-Path $fontDir "Eurocaps.ttf"
          Invoke-WebRequest -Uri $fontUrl -OutFile $fontPath

      - name: Install Inno Setup
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          choco install innosetup --no-progress -y

      - name: Build installer with Inno Setup
        if: ${{ hashFiles('scripts/installer.iss') != '' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $env:Path += ";C:\\Program Files (x86)\\Inno Setup 6"
          $workspace = (Get-Location).ProviderPath
          $outputDir = Join-Path $workspace "dist\\inno_output"
          $payloadRoot = Join-Path $workspace "dist\\inno_payload"
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
          iscc scripts\\installer.iss /DAppVersion="${env:VERSION}" /DOutputDir="$outputDir" /DPayloadRoot="$payloadRoot"

      - name: Upload prototype artifacts
        uses: actions/upload-artifact@v4
        with:
          name: inno-prototype
          path: |
            dist/inno_output/*.exe
            dist/inno_payload/**
            scripts/installer.iss
          if-no-files-found: warn
