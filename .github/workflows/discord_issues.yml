name: Discord Issue Notifications
permissions:
  issues: read

on:
  issues:
    types: [opened, edited, closed]
  issue_comment:
    types: [created, edited, deleted]


jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK secret is not set." >&2
            exit 1
          fi

          payload=$(jq -n \
            --arg action "${{ github.event.action }}" \
            --arg number "${{ github.event.issue.number }}" \
            --arg title "${{ github.event.issue.title }}" \
            --arg user "${{ github.event.issue.user.login }}" \
            --arg url "${{ github.event.issue.html_url }}" \
            '{content: ("Issue #" + $number + " " + $action + " by " + $user + "\n" + $title + "\n" + $url)}')

          curl -X POST -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK"
